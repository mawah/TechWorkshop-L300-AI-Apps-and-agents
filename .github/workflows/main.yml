name: Customer Loyalty Agent Initializer

on:
  push:
    paths:
      - "src/app/agents/customerLoyaltyAgent_initializer.py"
      - "src/prompts/CustomerLoyaltyAgentPrompt.txt"
      - "src/app/tools/discountLogic.py"
  pull_request:
    paths:
      - "src/app/agents/customerLoyaltyAgent_initializer.py"
      - "src/prompts/CustomerLoyaltyAgentPrompt.txt"
      - "src/app/tools/discountLogic.py"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: customer-loyalty-agent-initializer-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run-initializer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install src/requirements.txt

      # Fail fast if required Azure secrets are not set.
      - name: Validate Azure environment variables are present
        run: |
          required_vars=(
            AZURE_AI_PROJECTS_ENDPOINT
            AZURE_AI_PROJECTS_KEY
          )
          missing=0
          for v in "${required_vars[@]}"; do
            if [ -z "${!v}" ]; then
              echo "Missing required env var: $v"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            echo "One or more required Azure env vars are missing. Configure them as GitHub Secrets."
            exit 1
          fi
        env:
          AZURE_AI_PROJECTS_ENDPOINT: ${{ env.FOUNDRY_ENDPOINT }}
          AZURE_AI_PROJECTS_KEY: ${{ env.FOUNDRY_KEY }}
        secrets: |
            ENV=${{ secrets.ENV }}

      - name: Run Customer Loyalty Agent initializer
        run: |
          python src/app/agents/customerLoyaltyAgent_initializer.py
        env:
          # Project endpoint + key auth (instead of connection string)
          AZURE_AI_PROJECTS_ENDPOINT: ${{ env.FOUNDRY_ENDPOINT }}
          AZURE_AI_PROJECTS_KEY: ${{ env.FOUNDRY_KEY }}

          # Optional: if your code uses other Azure auth mechanisms too
          AZURE_TENANT_ID: ${{ env.TENANT_ID }}
          AZURE_CLIENT_ID: ${{ env.CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ env.CLIENT_SECRET }}
        secrets: |
            ENV=${{ secrets.ENV }}
